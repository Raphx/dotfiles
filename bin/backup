#!/usr/bin/env bash

usage="Usage: $0 [-e] [-m]

Backup files in an archive file, and optionally move the archive
to external drive.

Options:

  -e    Eject external drive after script execution
  -m    Move backup files to external drive

  -h    Show this help message"

for i in "$@"
do
case $i in
-e)
  eject_drive=1
  shift
  ;;
-m)
  backup_move=1
  shift
  ;;
-h)
  echo "$usage"
  exit 0
  ;;
*)
  echo "$usage"
  exit 1
  ;;
esac
done

# The backup directory
backup_dirname="arch-bk"
backup_dir="$HOME/Downloads/$backup_dirname"
mkdir -p "$backup_dir"

echo "  Backing up to $backup_dir ..."

# Project files
7z a -mx=0 "$backup_dir/p" "$HOME/Downloads/p"

# Other user files
## .gnupg
## .ssh
7z a -mx=0 "$backup_dir/arch" \
  "$HOME/.gnupg" \
  "$HOME/.ssh"

# Move backup files to external drive
if [ $backup_move ]
then
  external_dir="/mnt/backup"

  echo "  Removing old backup at $external_dir/$backup_dirname ..."
  rm -r "$external_dir/$backup_dirname"

  echo "  Moving backup from $backup_dir to $external_dir ..."
  mv "$backup_dir" "$external_dir"
fi

# Eject external drive
if [ $eject_drive ]
then
  echo "  Ejecting external drive ..."
  sudo umount -R /mnt
fi
