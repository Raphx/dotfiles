#!/usr/bin/env bash

# Backup files in an archive file, and optionally move the archive
# to external drive

# CLI usage message
usage="Usage: $0 [-c] [-e] [-m]

Options:

  -c    Clean OS attribute files from directories
  -e    Eject external drive after script execution
  -m    Move backup files to external drive

  -h    Show this help message"

# CLI arguments
for i in "$@"
do
case $i in
-c)
  backup_clean=1
  shift
  ;;
-e)
  eject_drive=1
  shift
  ;;
-m)
  backup_move=1
  shift
  ;;
-h)
  echo "$usage"
  exit 0
  ;;
*)
  echo "$usage"
  exit 1
  ;;
esac
done

# OS attribute files cleanup
if [ $backup_clean ]
then
  echo " [*] Cleaning up OS attribute files ..."

  osfiles=".DS_Store "
  for f in $osfiles
  do
    find ~/Downloads -name "$f" -print -delete
  done
fi

# The backup directory
backup_dirname="osx-bk"
backup_dir=~/Downloads/$backup_dirname
mkdir -p $backup_dir

echo " [*] Backing up to $backup_dir ..."

# Project files
7z a -mx=0 $backup_dir/p ~/Downloads/p

# Other user files
## .gnupg
## .ssh
7z a -mx=0 $backup_dir/osx \
  ~/.gnupg \
  ~/.ssh

# Move backup files to external drive
if [ $backup_move ]
then
  external_dir="/Volumes/Rph093/backup"

  echo " [*] Removing old backup at $external_dir/$backup_dirname ..."
  rm -r "$external_dir/$backup_dirname"

  echo " [*] Moving backup from $backup_dir to $external_dir ..."
  mv "$backup_dir" "$external_dir"
fi

# Eject external drive
if [ $eject_drive ]
then
  echo " [*] Ejecting external drive ..."
  diskutil eject Rph093
fi
