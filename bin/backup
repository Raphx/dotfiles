#!/usr/bin/env bash

readonly USAGE="
Backup files to an archive, and encrypt it.

Usage:

  $(basename "$0") [options]

Options:

  -h    Show this help message
"

# On macOS, use Homebrew-installed OpenSSL over macOS default
# LibreSSL. The latter is outdated most of the time.
if [ "$(uname)" == "Darwin" ]; then
  OPENSSL="/usr/local/Cellar/openssl@1.1/1.1.1g/bin/openssl"
else
  OPENSSL="openssl"
fi
readonly OPENSSL

# Output directory
readonly OUTPUTDIRPATH="$HOME/Downloads"

# Timestamp for backup
readonly UNIXEPOCH=$(date +%s)

_die() {
  local error
  error="$1"
  echo "$error"
  exit 1
}

_prepare() {
  mkdir -p "$OUTPUTDIRPATH"
}

_backup_documents() {
  local TARGETS
  local ARCHIVEFILEPATH
  local item

  TARGETS="$HOME/Documents"
  ARCHIVEFILEPATH="$OUTPUTDIRPATH/backup-$UNIXEPOCH.tar.gz.gpg"

  echo "Archiving files and directories:"
  for item in $TARGETS; do
    echo "  $item"
  done

  echo "Storing archive to $ARCHIVEFILEPATH ..."
  #shellcheck disable=SC2086
  tar cz $TARGETS 2>/dev/null \
    | gpg -se -r 07422797E98CA677D988A98D7C0FB9ABA36DC65A > "$ARCHIVEFILEPATH"
}

_backup_keys() {
  local GNUPGPATH
  local TARGETS
  local ARCHIVEFILE
  local item

  echo "Exporting GPG keys ..."

  GNUPGPATH="$HOME/.gnupg-export"
  mkdir -p "$GNUPGPATH"
  gpg --export-secret-keys > "$GNUPGPATH/priv.asc"
  gpg --export > "$GNUPGPATH/pub.asc"
  gpg --export-ownertrust > "$GNUPGPATH/trust.asc"

  TARGETS="$GNUPGPATH $HOME/.keys $HOME/.mutt $HOME/.ssh"
  ARCHIVEFILE="keys-$UNIXEPOCH.tar.gz.enc"
  DIGESTFILE="$ARCHIVEFILE.sum"

  # Using pushd so sha512sum generates checksum for file without
  # embedding the full path of the file in the checksum file
  pushd "$OUTPUTDIRPATH" >/dev/null || _die "pushd failed"

  echo "Archiving keys:"
  for item in $TARGETS; do
    echo "  $item"
  done

  echo "Storing archive to $OUTPUTDIRPATH/$ARCHIVEFILE ..."
  #shellcheck disable=SC2086
  tar cz $TARGETS 2>/dev/null \
    | "$OPENSSL" enc -aes-256-cbc -e -md sha512 -pbkdf2 -iter 20000 > "$ARCHIVEFILE"

  echo "Generating checksum ..."

  sha512sum "$ARCHIVEFILE" > "$DIGESTFILE"

  rm -r "$GNUPGPATH"

  popd >/dev/null || _die "popd failed"
}

while [ -n "$1" ]; do
  case "$1" in
    -h)
      echo "$USAGE"
      exit 0
      ;;
    *)
      _die "$USAGE"
      ;;
  esac
done

_prepare
_backup_keys
_backup_documents

echo "Done."
