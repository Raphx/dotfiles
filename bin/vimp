#!/usr/bin/env bash

readonly USAGE="
Vim plugin management using Git sources.

Usage:

  $(basename "$0") [options] <subcommand>

Subcommands:

  i <url>     Install a plugin via a Git SSH or HTTPS URL
  u <name>    Remove an installed plugin using project name.
              Example https://github.com/foo/bar, 'bar' is
              the project name.
  l           List all installed plugins

Options:

  -h    Show this help message
"

readonly VIMDIR="$HOME/.local/share/vim/pack/plugins"

_die() {
  echo "$USAGE"
  exit 1
}

_install() {
  local url="$1"
  local name
  name=$(basename "$url")
  name=${name%.git}

  git -C "$VIMDIR" submodule add "$url" "start/$name"
}

_uninstall() {
  local name="$1"

  git -C "$VIMDIR" submodule deinit -f "$VIMDIR/start/$name"
  git -C "$VIMDIR" rm -rf "$VIMDIR/start/$name"
  rm -rf "$VIMDIR/.git/modules/start/$name"
}

_list() {
  git -C "$VIMDIR" submodule
}

[ $# -eq 0 ] && _die

while [ -n "$1" ]; do
  case "$1" in
    i)
      shift
      [ -z "$1" ] && _die
      _install "$1"
      exit 0
      ;;
    u)
      shift
      [ -z "$1" ] && _die
      _uninstall "$1"
      exit 0
      ;;
    l)
      _list
      exit 0
      ;;
    -h)
      echo "$USAGE"
      exit 0
      ;;
    *)
      _die
      ;;
  esac
done
